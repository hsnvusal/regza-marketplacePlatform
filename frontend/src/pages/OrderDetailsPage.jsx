import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import ordersService from '../services/ordersService';
import toastManager from '../utils/toastManager';
import './OrderDetailsPage.css';

const OrderDetailsPage = () => {
  const { orderId } = useParams();
  const { user } = useAuth();
  const navigate = useNavigate();

  // State
  const [order, setOrder] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [trackingData, setTrackingData] = useState(null);
  const [isUpdatingStatus, setIsUpdatingStatus] = useState(false);
  const [showTrackingForm, setShowTrackingForm] = useState(false);
  const [newStatus, setNewStatus] = useState('');
  const [statusNotes, setStatusNotes] = useState('');

  // Tracking form state
  const [trackingForm, setTrackingForm] = useState({
    trackingNumber: '',
    carrier: 'azerpost',
    status: 'shipped',
    location: '',
    notes: '',
    estimatedDelivery: ''
  });

  // Load order details
  useEffect(() => {
    if (orderId && user?.id) {
      loadOrderDetails();
    } else {
      console.warn('‚ö†Ô∏è Missing required data:', { orderId, userId: user?.id });
      if (!orderId) {
        toastManager.error('Sifari≈ü ID tapƒ±lmadƒ±');
        navigate('/orders');
      }
    }
  }, [orderId, user?.id]);

  const loadOrderDetails = async () => {
    setIsLoading(true);
    try {
      console.log('üîÑ Loading order details for:', orderId);
      
      const result = await ordersService.getOrder(orderId);
      console.log('üìã Raw API response:', result);
      
      if (result?.success) {
        let orderData = null;
        
        if (result.data?.data?.order) {
          orderData = result.data.data.order;
          console.log('üì¶ Using nested data.data.order structure');
        } else if (result.data?.order) {
          orderData = result.data.order;
          console.log('üì¶ Using nested order structure');
        } else if (result.data && typeof result.data === 'object' && result.data.orderNumber) {
          orderData = result.data;
          console.log('üì¶ Using direct order structure');
        }
        
        if (orderData) {
          setOrder(orderData);
          console.log('‚úÖ Order set successfully:', orderData.orderNumber);
        } else {
          console.error('‚ùå Could not extract order data from response');
          toastManager.error('Sifari≈ü m…ôlumatlarƒ± d√ºzg√ºn formatda deyil');
          navigate('/orders');
        }
      } else {
        console.error('‚ùå API returned unsuccessful response:', result);
        toastManager.error(result?.error || 'Sifari≈ü detaylarƒ± y√ºkl…ônm…ôdi');
        navigate('/orders');
      }
    } catch (error) {
      console.error('‚ùå Error loading order:', error);
      toastManager.error('Sifari≈ü detaylarƒ± y√ºkl…ôn…ôrk…ôn x…ôta ba≈ü verdi');
      navigate('/orders');
    } finally {
      setIsLoading(false);
    }
  };

  // Handle order cancellation
  const handleCancelOrder = async () => {
    if (!window.confirm('Bu sifari≈üi l…ôƒüv etm…ôk ist…ôdiyiniz…ô …ôminsiniz?')) return;

    try {
      const result = await ordersService.cancelOrder(orderId, 'M√º≈üt…ôri t…ôr…ôfind…ôn l…ôƒüv edildi');
      if (result?.success) {
        setOrder(prev => ({ ...prev, status: 'cancelled' }));
        toastManager.success('Sifari≈ü l…ôƒüv edildi');
      } else {
        toastManager.error(result?.error || 'Sifari≈ü l…ôƒüv edilm…ôdi');
      }
    } catch (error) {
      console.error('‚ùå Error cancelling order:', error);
      toastManager.error('L…ôƒüv edil…ôrk…ôn x…ôta ba≈ü verdi');
    }
  };

  // Handle payment confirmation (for admin/vendor)
  const handleConfirmPayment = async (paymentId) => {
    try {
      const result = await ordersService.confirmPayment(paymentId);
      if (result?.success) {
        setOrder(prev => ({
          ...prev,
          payment: { ...prev.payment, status: 'completed' }
        }));
        toastManager.success('√ñd…ôni≈ü t…ôsdiql…ôndi');
      } else {
        toastManager.error(result?.error || '√ñd…ôni≈ü t…ôsdiql…ônm…ôdi');
      }
    } catch (error) {
      console.error('‚ùå Error confirming payment:', error);
      toastManager.error('√ñd…ôni≈ü t…ôsdiql…ôndik…ôn x…ôta ba≈ü verdi');
    }
  };

  // Handle payment refund (for admin/vendor)
  const handleRefundPayment = async (paymentId) => {
    if (!window.confirm('Bu √∂d…ôni≈üi geri qaytarmaq ist…ôdiyiniz…ô …ôminsiniz?')) return;

    try {
      const result = await ordersService.refundPayment(paymentId);
      if (result?.success) {
        setOrder(prev => ({
          ...prev,
          payment: { ...prev.payment, status: 'refunded' }
        }));
        toastManager.success('√ñd…ôni≈ü geri qaytarƒ±ldƒ±');
      } else {
        toastManager.error(result?.error || '√ñd…ôni≈ü geri qaytarƒ±lmadƒ±');
      }
    } catch (error) {
      console.error('‚ùå Error refunding payment:', error);
      toastManager.error('Geri qaytarƒ±lark…ôn x…ôta ba≈ü verdi');
    }
  };

  // Utility functions
  const formatPrice = (price) => {
    return ordersService.formatPrice(price);
  };

  // T…ôkmill…ô≈üdirilmi≈ü tarix formatlamasƒ±
  const formatDate = (dateString) => {
    if (!dateString) return 'Tarix yoxdur';
    
    try {
      const date = new Date(dateString);
      
      if (isNaN(date.getTime())) {
        return 'Yanlƒ±≈ü tarix formatƒ±';
      }

      const day = date.getDate();
      const month = date.getMonth();
      const year = date.getFullYear();
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      
      const monthNames = [
        'Yanvar', 'Fevral', 'Mart', 'Aprel', 'May', 'ƒ∞yun',
        'ƒ∞yul', 'Avqust', 'Sentyabr', 'Oktyabr', 'Noyabr', 'Dekabr'
      ];

      return `${day} ${monthNames[month]} ${year}, ${hours}:${minutes}`;
      
    } catch (error) {
      console.error('Tarix formatlanark…ôn x…ôta:', error);
      return 'Tarix x…ôtasƒ±';
    }
  };

  // Qƒ±sa tarix formatƒ±
  const formatDateShort = (dateString) => {
    if (!dateString) return 'Tarix yoxdur';
    
    try {
      const date = new Date(dateString);
      
      if (isNaN(date.getTime())) {
        return 'Yanlƒ±≈ü tarix';
      }

      const day = date.getDate().toString().padStart(2, '0');
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const year = date.getFullYear();

      return `${day}.${month}.${year}`;
      
    } catch (error) {
      return 'Tarix x…ôtasƒ±';
    }
  };

  // Nisbi tarix
  const formatRelativeDate = (dateString) => {
    if (!dateString) return 'Tarix yoxdur';
    
    try {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / (1000 * 60));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

      if (diffMins < 1) {
        return 'ƒ∞ndi';
      } else if (diffMins < 60) {
        return `${diffMins} d…ôqiq…ô …ôvv…ôl`;
      } else if (diffHours < 24) {
        return `${diffHours} saat …ôvv…ôl`;
      } else if (diffDays === 1) {
        return 'D√ºn…ôn';
      } else if (diffDays < 7) {
        return `${diffDays} g√ºn …ôvv…ôl`;
      } else {
        return formatDateShort(dateString);
      }
    } catch (error) {
      return 'Tarix x…ôtasƒ±';
    }
  };

  const getStatusColor = (status) => {
    return ordersService.getStatusColor(status);
  };

  const getStatusText = (status) => {
    return ordersService.getStatusText(status);
  };

  const getOrderId = (order) => {
    return order?._id || order?.id;
  };

  const getOrderNumber = (order) => {
    return order?.orderNumber || order?._id || order?.id;
  };

  const getCustomerName = (order) => {
    if (order?.customer) {
      if (order.customer.firstName && order.customer.lastName) {
        return `${order.customer.firstName} ${order.customer.lastName}`;
      }
      return order.customer.name || order.customer.email || 'Nam…ôlum m√º≈üt…ôri';
    }
    return 'Nam…ôlum m√º≈üt…ôri';
  };

  const getVendorName = (vendorOrder) => {
    if (vendorOrder?.vendor) {
      const vendor = vendorOrder.vendor;
      if (vendor.businessName) return vendor.businessName;
      if (vendor.firstName && vendor.lastName) return `${vendor.firstName} ${vendor.lastName}`;
      if (vendor.name) return vendor.name;
      return vendor.email || 'Nam…ôlum satƒ±cƒ±';
    }
    return 'Nam…ôlum satƒ±cƒ±';
  };

  const getOrderItems = (order) => {
    if (order?.vendorOrders && order.vendorOrders.length > 0) {
      return order.vendorOrders.reduce((allItems, vendorOrder) => {
        return allItems.concat(vendorOrder.items || []);
      }, []);
    }
    return order?.items || [];
  };

  const getOrderTotal = (order) => {
    return order?.pricing?.total || order?.total || order?.totalAmount || 0;
  };

  const canCancelOrder = (order) => {
    return user?.role === 'customer' && 
           ['pending', 'confirmed'].includes(order?.status);
  };

  const canUpdateStatus = (order) => {
    return (user?.role === 'admin' || user?.role === 'vendor') &&
           !['completed', 'cancelled', 'refunded'].includes(order?.status);
  };

  const canUpdateTracking = () => {
    return user?.role === 'admin' || user?.role === 'vendor';
  };

  const canRefundPayment = (order) => {
    return (user?.role === 'admin' || user?.role === 'vendor') &&
           order?.payment?.status === 'completed' &&
           !['cancelled', 'refunded'].includes(order?.status);
  };

  if (isLoading) {
    return (
      <div className="order-details-loading">
        <div className="loading-spinner"></div>
        <p>Sifari≈ü detaylarƒ± y√ºkl…ônir...</p>
        <p className="loading-debug">Order ID: {orderId}</p>
        <p className="loading-debug">User: {user?.email}</p>
      </div>
    );
  }

  if (!order) {
    return (
      <div className="order-not-found">
        <div className="not-found-icon">‚ùå</div>
        <h2>Sifari≈ü tapƒ±lmadƒ±</h2>
        <p>Bu sifari≈ü m√∂vcud deyil v…ô ya sizin ona giri≈ü icaz…ôniz yoxdur.</p>
        <div className="debug-info">
          <p><strong>Debug Info:</strong></p>
          <p>Order ID: {orderId}</p>
          <p>User: {user?.email}</p>
          <p>Role: {user?.role}</p>
        </div>
        <button onClick={() => navigate('/orders')} className="back-btn">
          ‚Üê Sifari≈ül…ôr…ô qayƒ±t
        </button>
        <button onClick={loadOrderDetails} className="retry-btn">
          üîÑ Yenid…ôn c…ôhd et
        </button>
      </div>
    );
  }

  console.log('üé® Rendering order details:', {
    orderNumber: order.orderNumber,
    status: order.status,
    hasVendorOrders: !!order.vendorOrders?.length,
    hasPricing: !!order.pricing,
    hasCustomer: !!order.customer
  });

  const items = getOrderItems(order);
  console.log('üì¶ Order items:', items);

  return (
    <div className="order-details-page">
      <div className="order-details-container">
        {/* Header */}
        <div className="order-header">
          <div className="header-left">
            <button onClick={() => navigate('/orders')} className="back-btn">
              ‚Üê Geri
            </button>
            <div className="order-title">
              <h1>Sifari≈ü #{getOrderNumber(order)}</h1>
              <div 
                className="order-status-badge"
                style={{ 
                  backgroundColor: getStatusColor(order.status) + '20',
                  color: getStatusColor(order.status)
                }}
              >
                {getStatusText(order.status)}
              </div>
            </div>
          </div>
          
          <div className="header-actions">
            {canCancelOrder(order) && (
              <button 
                className="cancel-order-btn" 
                onClick={handleCancelOrder}
              >
                ‚ùå L…ôƒüv et
              </button>
            )}
            
            {user?.role === 'customer' && (
              <button 
                className="track-order-btn"
                onClick={() => navigate(`/orders/${orderId}/tracking`)}
              >
                üìç ƒ∞zl…ô
              </button>
            )}
            
            {canUpdateTracking() && (
              <button 
                className="update-tracking-btn"
                onClick={() => setShowTrackingForm(true)}
              >
                üì¶ Tracking yenil…ô
              </button>
            )}
          </div>
        </div>

        <div className="order-content">

          {/* Order Info */}
          <div className="order-info-section">
            <h2>üìã Sifari≈ü m…ôlumatlarƒ±</h2>
            <div className="info-grid">
              <div className="info-item">
                <label>Sifari≈ü ID:</label>
                <span>#{getOrderNumber(order)}</span>
              </div>
              <div className="info-item">
                <label>üìÖ Sifari≈ü tarixi:</label>
                <span className="order-date">
                  <div className="main-date">{formatDate(order.placedAt || order.createdAt)}</div>
                  <div className="relative-date">({formatRelativeDate(order.placedAt || order.createdAt)})</div>
                </span>
              </div>
              <div className="info-item">
                <label>Status:</label>
                <span style={{ color: getStatusColor(order.status) }}>
                  {getStatusText(order.status)}
                </span>
              </div>
              <div className="info-item">
                <label>√úmumi m…ôbl…ôƒü:</label>
                <span className="total-amount">{formatPrice(getOrderTotal(order))}</span>
              </div>
              {user?.role !== 'customer' && order.customer && (
                <div className="info-item">
                  <label>M√º≈üt…ôri:</label>
                  <span>{getCustomerName(order)}</span>
                </div>
              )}
              {order.customerNotes && (
                <div className="info-item full-width">
                  <label>M√º≈üt…ôri qeydi:</label>
                  <span>{order.customerNotes}</span>
                </div>
              )}
              {order.source && (
                <div className="info-item">
                  <label>M…ônb…ô:</label>
                  <span>{order.source}</span>
                </div>
              )}
            </div>
          </div>

          {/* Order Items */}
          <div className="order-items-section">
            <h2>üõçÔ∏è Sifari≈ü edil…ôn m…ôhsullar</h2>
            
            {/* Vendor-l…ôr…ô g√∂r…ô qrupla≈üdƒ±rƒ±lmƒ±≈ü m…ôhsullar */}
            {order.vendorOrders && order.vendorOrders.length > 0 ? (
              order.vendorOrders.map((vendorOrder, vendorIndex) => (
                <div key={vendorOrder._id || vendorIndex} className="vendor-order-group">
                  <div className="vendor-header">
                    <h3>üè™ {getVendorName(vendorOrder)}</h3>
                    <span className="vendor-order-number">
                      #{vendorOrder.vendorOrderNumber}
                    </span>
                    {vendorOrder.status && (
                      <span 
                        className="vendor-status-badge"
                        style={{ 
                          backgroundColor: getStatusColor(vendorOrder.status) + '20',
                          color: getStatusColor(vendorOrder.status)
                        }}
                      >
                        {getStatusText(vendorOrder.status)}
                      </span>
                    )}
                  </div>
                  
                  <div className="vendor-items">
                    {vendorOrder.items.map((item, itemIndex) => {
                      const product = item.productSnapshot || item.product || {};
                      return (
                        <div key={item._id || itemIndex} className="order-item">
                          <div className="item-image">
                            {product.image ? (
                              <img src={product.image} alt={product.name} />
                            ) : (
                              <div className="no-image">üì¶</div>
                            )}
                          </div>
                          <div className="item-details">
                            <h4>{product.name || 'M…ôhsul'}</h4>
                            {product.sku && (
                              <p className="item-sku">SKU: {product.sku}</p>
                            )}
                            {product.brand && (
                              <p className="item-brand">Brend: {product.brand}</p>
                            )}
                            <div className="item-quantity">
                              Miqdar: {item.quantity || 1}
                            </div>
                          </div>
                          <div className="item-pricing">
                            <div className="unit-price">
                              {formatPrice(item.unitPrice)} / …ôd…ôd
                            </div>
                            <div className="total-price">
                              {formatPrice(item.totalPrice || (item.unitPrice * item.quantity))}
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  
                  {/* Vendor order tracking */}
                  {vendorOrder.tracking && (
                    <div className="vendor-tracking">
                      <strong>Bu vendor √º√ß√ºn tracking:</strong>
                      <span className="tracking-number">
                        {vendorOrder.tracking.trackingNumber}
                      </span>
                    </div>
                  )}
                </div>
              ))
            ) : (
              // Fallback: …ôg…ôr vendorOrders yoxdursa, birba≈üa items g√∂st…ôr
              <div className="items-list">
                {getOrderItems(order).map((item, index) => {
                  const product = item.productSnapshot || item.product || {};
                  return (
                    <div key={item._id || index} className="order-item">
                      <div className="item-image">
                        {product.image ? (
                          <img src={product.image} alt={product.name} />
                        ) : (
                          <div className="no-image">üì¶</div>
                        )}
                      </div>
                      <div className="item-details">
                        <h3>{product.name || 'M…ôhsul'}</h3>
                        {product.sku && (
                          <p className="item-sku">SKU: {product.sku}</p>
                        )}
                        <div className="item-quantity">
                          Miqdar: {item.quantity || 1}
                        </div>
                      </div>
                      <div className="item-pricing">
                        <div className="unit-price">
                          {formatPrice(item.unitPrice)}
                        </div>
                        <div className="total-price">
                          {formatPrice((item.unitPrice || 0) * (item.quantity || 1))}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>

          {/* Pricing Breakdown */}
          <div className="pricing-section">
            <h2>üí∞ √ñd…ôni≈ü detallarƒ±</h2>
            <div className="pricing-breakdown">
              <div className="pricing-row">
                <span>M…ôhsullarƒ±n d…ôy…ôri:</span>
                <span>{formatPrice(order.pricing?.subtotal || 0)}</span>
              </div>
              {order.pricing?.shipping > 0 && (
                <div className="pricing-row">
                  <span>√áatdƒ±rƒ±lma:</span>
                  <span>{formatPrice(order.pricing.shipping)}</span>
                </div>
              )}
              {order.pricing?.tax > 0 && (
                <div className="pricing-row">
                  <span>Vergi:</span>
                  <span>{formatPrice(order.pricing.tax)}</span>
                </div>
              )}
              {order.pricing?.discount > 0 && (
                <div className="pricing-row discount">
                  <span>Endirim:</span>
                  <span>-{formatPrice(order.pricing.discount)}</span>
                </div>
              )}
              <div className="pricing-row total">
                <span><strong>√úmumi:</strong></span>
                <span><strong>{formatPrice(getOrderTotal(order))}</strong></span>
              </div>
            </div>
          </div>

          {/* Payment Info - T…ôkmill…ô≈üdirilmi≈ü */}
          {order.payment && (
            <div className="payment-section">
              <h2>üí≥ √ñd…ôni≈ü m…ôlumatlarƒ±</h2>
              
              <div className="payment-card">
                <div className="payment-header">
                  <div className="payment-method-info">
                    <div className="payment-icon">
                      {order.payment.method === 'card' ? 'üí≥' : 
                       order.payment.method === 'cash' ? 'üíµ' : 
                       order.payment.method === 'bank_transfer' ? 'üè¶' : 'üí∞'}
                    </div>
                    <div className="payment-details">
                      <span className="payment-method">
                        {order.payment.method === 'card' ? 'Kredit/Debit Kartƒ±' :
                         order.payment.method === 'cash' ? 'Naƒüd √∂d…ôni≈ü' :
                         order.payment.method === 'bank_transfer' ? 'Bank k√∂√ß√ºrm…ôsi' :
                         ordersService.getPaymentMethodText(order.payment.method)}
                      </span>
                      
                      {order.payment.method === 'card' && (
                        <div className="card-info">
                          <span className="card-number">
                            ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {order.payment.cardLast4 || '****'}
                          </span>
                          {order.payment.cardBrand && (
                            <span className="card-brand">
                              {order.payment.cardBrand.toUpperCase()}
                            </span>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                  
                  <div className="payment-status-wrapper">
                    <span className={`payment-status ${order.payment.status}`}>
                      {order.payment.status === 'completed' ? '‚úÖ Tamamlandƒ±' :
                       order.payment.status === 'pending' ? '‚è≥ G√∂zl…ôyir' :
                       order.payment.status === 'failed' ? '‚ùå Uƒüursuz' :
                       order.payment.status === 'refunded' ? 'üîÑ Geri qaytarƒ±ldƒ±' :
                       ordersService.getPaymentStatusText(order.payment.status)}
                    </span>
                  </div>
                </div>

                <div className="payment-info">
                  <div className="payment-row">
                    <span>√ñd…ôni≈ü m…ôbl…ôƒüi:</span>
                    <span className="payment-amount">
                      {formatPrice(order.payment.amount || getOrderTotal(order))}
                    </span>
                  </div>
                  
                  <div className="payment-row">
                    <span>√ñd…ôni≈ü √ºsulu:</span>
                    <span>
                      {order.payment.method === 'card' ? 'Kartla √∂d…ôni≈ü' :
                       order.payment.method === 'cash' ? '√áatdƒ±rƒ±lma zamanƒ± naƒüd' :
                       order.payment.method === 'bank_transfer' ? 'Bank transferi' :
                       ordersService.getPaymentMethodText(order.payment.method)}
                    </span>
                  </div>
                  
                  <div className="payment-row">
                    <span>√ñd…ôni≈ü statusu:</span>
                    <span className={`payment-status ${order.payment.status}`}>
                      {order.payment.status === 'completed' ? 'Tamamlandƒ±' :
                       order.payment.status === 'pending' ? 'G√∂zl…ôyir' :
                       order.payment.status === 'failed' ? 'Uƒüursuz' :
                       order.payment.status === 'refunded' ? 'Geri qaytarƒ±ldƒ±' :
                       ordersService.getPaymentStatusText(order.payment.status)}
                    </span>
                  </div>
                  
                  {order.payment.paidAt && (
                    <div className="payment-row">
                      <span>üí≥ √ñd…ôni≈ü tarixi:</span>
                      <span className="payment-date">
                        <div className="main-date">{formatDate(order.payment.paidAt)}</div>
                        <div className="relative-date">{formatRelativeDate(order.payment.paidAt)}</div>
                      </span>
                    </div>
                  )}
                  
                  {order.payment.transactionId && (
                    <div className="payment-row">
                      <span>∆èm…ôliyyat ID:</span>
                      <span className="transaction-id">{order.payment.transactionId}</span>
                    </div>
                  )}

                  {order.payment.method === 'card' && order.payment.cardHolderName && (
                    <div className="payment-row">
                      <span>Kart sahibi:</span>
                      <span>{order.payment.cardHolderName}</span>
                    </div>
                  )}

                  {order.payment.method === 'bank_transfer' && order.payment.bankName && (
                    <div className="payment-row">
                      <span>Bank:</span>
                      <span>{order.payment.bankName}</span>
                    </div>
                  )}

                  {order.payment.method === 'bank_transfer' && order.payment.referenceNumber && (
                    <div className="payment-row">
                      <span>ƒ∞stinad n√∂mr…ôsi:</span>
                      <span>{order.payment.referenceNumber}</span>
                    </div>
                  )}

                  {order.payment.processingFee && order.payment.processingFee > 0 && (
                    <div className="payment-row">
                      <span>Emal haqqƒ±:</span>
                      <span>{formatPrice(order.payment.processingFee)}</span>
                    </div>
                  )}

                  {order.payment.gateway && (
                    <div className="payment-row">
                      <span>√ñd…ôni≈ü sistemi:</span>
                      <span>
                        {order.payment.gateway === 'stripe' ? 'Stripe' :
                         order.payment.gateway === 'paypal' ? 'PayPal' :
                         order.payment.gateway === 'kapital' ? 'Kapital Bank' :
                         order.payment.gateway === 'azerpost' ? 'Az…ôrpo√ßt' :
                         order.payment.gateway}
                      </span>
                    </div>
                  )}
                </div>

                {/* T…ôhl√ºk…ôsizlik m…ôlumatlarƒ± */}
                <div className="payment-security">
                  <div className="security-badge">
                    üîí Bu √∂d…ôni≈ü t…ôhl√ºk…ôsiz SSL ≈üifr…ôl…ôm…ôsi il…ô h…ôyata ke√ßirilmi≈üdir
                  </div>
                  {order.payment.verified && (
                    <div className="verification-badge">
                      ‚úÖ Kart yoxlanmasƒ± tamamlandƒ±
                    </div>
                  )}
                </div>

                {/* Admin/Vendor √º√ß√ºn √∂d…ôni≈ü …ôm…ôliyyatlarƒ± */}
                {(user?.role === 'admin' || user?.role === 'vendor') && (
                  <div className="payment-actions">
                    {order.payment.status === 'pending' && (
                      <button 
                        className="confirm-payment-btn"
                        onClick={() => handleConfirmPayment(order.payment.id)}
                      >
                        ‚úÖ √ñd…ôni≈üi t…ôsdiql…ô
                      </button>
                    )}
                    
                    {order.payment.status === 'completed' && canRefundPayment(order) && (
                      <button 
                        className="refund-payment-btn"
                        onClick={() => handleRefundPayment(order.payment.id)}
                      >
                        üîÑ √ñd…ôni≈üi geri qaytar
                      </button>
                    )}
                  </div>
                )}

                {/* Geri qaytarma m…ôlumatlarƒ± */}
                {order.payment.refunds && order.payment.refunds.length > 0 && (
                  <div className="refund-info">
                    <h3>üîÑ Geri qaytarma tarix√ß…ôsi</h3>
                    {order.payment.refunds.map((refund, index) => (
                      <div key={index} className="refund-item">
                        <div className="refund-header">
                          <span className="refund-amount">
                            {formatPrice(refund.amount)}
                          </span>
                          <div className="refund-date-info">
                            <div className="refund-date-main">
                              {formatDate(refund.processedAt)}
                            </div>
                            <div className="refund-date-relative">
                              {formatRelativeDate(refund.processedAt)}
                            </div>
                          </div>
                        </div>
                        {refund.reason && (
                          <div className="refund-reason">
                            üìù S…ôb…ôb: {refund.reason}
                          </div>
                        )}
                        {refund.status && (
                          <div className={`refund-status ${refund.status}`}>
                            {refund.status === 'completed' ? '‚úÖ Tamamlandƒ±' :
                             refund.status === 'pending' ? '‚è≥ Proses edilir' :
                             refund.status === 'failed' ? '‚ùå Uƒüursuz' : refund.status}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Shipping Address */}
          {order.shippingAddress && (
            <div className="shipping-section">
              <h2>üè† √áatdƒ±rƒ±lma √ºnvanƒ±</h2>
              <div className="address-info">
                <p>
                  <strong>
                    {order.shippingAddress.firstName} {order.shippingAddress.lastName}
                  </strong>
                </p>
                <p>üìß {order.shippingAddress.email}</p>
                {order.shippingAddress.phone && (
                  <p>üìû {order.shippingAddress.phone}</p>
                )}
                {order.shippingAddress.street && (
                  <p>üè¢ {order.shippingAddress.street}</p>
                )}
                {order.shippingAddress.city && (
                  <p>üèôÔ∏è {order.shippingAddress.city}</p>
                )}
                <p>üåç {order.shippingAddress.country || 'Azerbaijan'}</p>
                {order.shippingAddress.deliveryInstructions && (
                  <div className="delivery-instructions">
                    <strong>üìã √áatdƒ±rƒ±lma t…ôlimatlarƒ±:</strong>
                    <p>{order.shippingAddress.deliveryInstructions}</p>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Order History - T…ôkmill…ô≈üdirilmi≈ü */}
          {order.orderHistory && order.orderHistory.length > 0 && (
            <div className="order-history-section">
              <h2>üìã Sifari≈ü tarix√ß…ôsi</h2>
              <div className="history-timeline">
                {order.orderHistory
                  .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                  .map((history, index) => (
                    <div key={index} className="history-item">
                      <div className="history-timestamp">
                        <div className="history-date-main">
                          {formatDate(history.timestamp)}
                        </div>
                        <div className="history-date-relative">
                          {formatRelativeDate(history.timestamp)}
                        </div>
                      </div>
                      <div className="history-content">
                        <div className="history-status">
                          <span 
                            className="status-badge"
                            style={{ 
                              backgroundColor: getStatusColor(history.status) + '20',
                              color: getStatusColor(history.status)
                            }}
                          >
                            {getStatusText(history.status)}
                          </span>
                        </div>
                        {history.note && (
                          <div className="history-note">
                            üí¨ {history.note}
                          </div>
                        )}
                        {history.updatedBy && (
                          <div className="history-updated-by">
                            üë§ {history.updatedBy}
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default OrderDetailsPage;